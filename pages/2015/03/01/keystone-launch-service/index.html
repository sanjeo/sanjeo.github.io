﻿<!DOCTYPE html>
<html lang="zh">
<head>

        <title>Keystone源码分析 - keystone服务的启动</title>
		
        <meta charset="utf-8" />
        <link href="http://www.sanjeo.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Sanjeo's Blog Full Atom Feed" />


        <!-- Mobile viewport optimized: j.mp/bplateviewport -->
        <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1">

        <link rel="stylesheet" type="text/css" href="http://www.sanjeo.com/theme/gumby.css" />
        <link rel="stylesheet" type="text/css" href="http://www.sanjeo.com/theme/style.css" />
        <link rel="stylesheet" type="text/css" href="http://www.sanjeo.com/theme/pygment.css" />

        <script src="http://www.sanjeo.com/theme/js/libs/modernizr-2.6.2.min.js"></script>






</head>

<body id="index" class="home">

<!-- Fork me on github -->

    <div class="container">

        <div class="row">

          <header id="banner" class="body">
                  <h1><a href="http://www.sanjeo.com">Sanjeo's Blog <strong></strong></a></h1>
          </header><!-- /#banner -->

            <div id="navigation" class="navbar row">
              <a href="#" gumby-trigger="#navigation &gt; ul" class="toggle"><i class="icon-menu"></i></a>
             
              <ul class="columns">
                <li><a href="/">Home</a></li>
					<!--<li><a href="http://www.sanjeo.com/category/linux.html">Linux</a></li>-->
					<li><a href="http://www.sanjeo.com/category/linux.html">Linux</a></li>
					<!--<li class="active"><a href="http://www.sanjeo.com/category/openstack.html">OpenStack</a></li>-->
					<li><a href="http://www.sanjeo.com/category/openstack.html">OpenStack</a></li>
				<li><a href="/functions/archives.html">Archives</a></li>
				<li><a href="/functions/random.html">Random Article</a></li>
				<!--
					<li><a href="/functions/categories.html">Categories</a></li>
					<li><a href="/functions/tags.html">Tags</a></li>
					<li><a href="/functions/archives.html">Archives</a></li>
				
				-->
              </ul>
            </div>

<section id="content" class="body">

   <div class="row">
        <div class="eleven columns">


            <header>
              <h2 class="entry-title">
                <a href="http://www.sanjeo.com/pages/2015/03/01/keystone-launch-service/" rel="bookmark"
                   title="Permalink to Keystone源码分析 - keystone服务的启动">Keystone源码分析 - keystone服务的启动</a></h2>
           
            </header>
            <footer class="post-info">
              <!--
			  <abbr class="published" title="2015-03-01T10:30:00">
                Sun 01 March 2015
              </abbr>
              <address class="vcard author">
                By <a class="url fn" href="http://www.sanjeo.com/author/sanjeo.html">Sanjeo</a>
              </address>
			  -->
			  <address class="vcard author" style="font-style:italic;margin-bottom:-10px;">
				Sun 01 March 2015
					&nbsp;&nbsp;Write By <a class="url fn" href="http://www.sanjeo.com/author/sanjeo.html">Sanjeo</a>
	
			  </address>
			  <hr />			  
            </footer><!-- /.post-info -->
            <div class="entry-content">
              <p>本文主要学习keystone服务的启动以及初始化过程。</p>
<p>首先从<code>keystone-all.py</code>入手分析，该文件是启动keystone服务的入口。</p>
<div class="highlight"><pre><span class="c">#[bin/keystone-all.py]</span>
<span class="n">possible_topdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span>
                                   <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span>
                                   <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">possible_topdir</span><span class="p">,</span>
                              <span class="s">&#39;keystone&#39;</span><span class="p">,</span>
                               <span class="s">&#39;__init__.py&#39;</span><span class="p">)):</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">possible_topdir</span><span class="p">)</span>
</pre></div>


<p>这段代码对keystone下各个模块的代码路径进行配置，使其位于系统路径下。然后调用eventlet模块的<code>run</code>函数来配置并启动运行keystone服务的server。</p>
<div class="highlight"><pre><span class="c">#[bin/keystone-all.py]</span>
<span class="kn">from</span> <span class="nn">keystone.server</span> <span class="kn">import</span> <span class="n">eventlet</span> <span class="k">as</span> <span class="n">eventlet_server</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">eventlet_server</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">possible_topdir</span><span class="p">)</span>
</pre></div>


<p>接下来跟踪eventlet_server类的run函数，这是启动keystone服务的主体程序：</p>
<h5>1. 尝试获取config_files的路径</h5>
<div class="highlight"><pre>    <span class="c">#[keystone/server/eventlet.py]</span>
    <span class="n">dev_conf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">possible_topdir</span><span class="p">,</span>
                            <span class="s">&#39;etc&#39;</span><span class="p">,</span>
                            <span class="s">&#39;keystone.conf&#39;</span><span class="p">)</span>
    <span class="n">config_files</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dev_conf</span><span class="p">):</span>
        <span class="n">config_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">dev_conf</span><span class="p">]</span>
</pre></div>


<h5>2. 初始化上下文环境</h5>
<div class="highlight"><pre>    <span class="c">#[keystone/server/eventlet.py]</span>
    <span class="n">common</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span> <span class="c">#from keystone.server import common</span>
        <span class="n">version</span><span class="o">=</span><span class="n">pbr</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">VersionInfo</span><span class="p">(</span><span class="s">&#39;keystone&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">version_string</span><span class="p">(),</span>
        <span class="n">config_files</span><span class="o">=</span><span class="n">config_files</span><span class="p">,</span>
    <span class="n">pre_setup_logging_fn</span><span class="o">=</span><span class="n">configure_threading</span><span class="p">)</span>
</pre></div>


<p>首先看一下<code>common.py</code>文件中的configure函数：</p>
<div class="highlight"><pre><span class="c">#[keystone/server/common.py]</span>
<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">config_files</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
              <span class="n">pre_setup_logging_fn</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">None</span><span class="p">):</span>
    <span class="n">config</span><span class="o">.</span><span class="n">configure</span><span class="p">()</span>
    <span class="n">sql</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set_default_for_default_log_levels</span><span class="p">()</span>

    <span class="n">CONF</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="s">&#39;keystone&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
         <span class="n">default_config_files</span><span class="o">=</span><span class="n">config_files</span><span class="p">)</span>

    <span class="n">pre_setup_logging_fn</span><span class="p">()</span>
    <span class="n">config</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">()</span>
</pre></div>


<h6>a. <code>config.configure</code>完成配置参数的注册:</h6>
<div class="highlight"><pre><span class="c">#[keystone/common/config.py]</span>
<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">conf</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="n">CONF</span>
</pre></div>


<p>其中CONF为<code>oslo.config.cfg.CONF</code>,其作用主要用来注册参数。其中被注册的参数，常见的一种是我们在配置文件中指定好，并通过<code>register_opt</code>函数来进行注册的，还有一种是通过<code>register_cli_opt</code>来注册通过命令行设置的参数，如：</p>
<div class="highlight"><pre><span class="c">#[keystone/common/config.py]</span>
<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">conf</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="o">...</span>
    <span class="n">conf</span><span class="o">.</span><span class="n">register_cli_opt</span><span class="p">(</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">BoolOpt</span><span class="p">(</span><span class="s">&#39;standard-threads&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s">&#39;Do not monkey-patch threading system modules.&#39;</span><span class="p">))</span>
    <span class="n">conf</span><span class="o">.</span><span class="n">register_cli_opt</span><span class="p">(</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">StrOpt</span><span class="p">(</span><span class="s">&#39;pydev-debug-host&#39;</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s">&#39;Host to connect to for remote debugger.&#39;</span><span class="p">))</span>
    <span class="n">conf</span><span class="o">.</span><span class="n">register_cli_opt</span><span class="p">(</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">IntOpt</span><span class="p">(</span><span class="s">&#39;pydev-debug-port&#39;</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s">&#39;Port to connect to for remote debugger.&#39;</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">FILE_OPTIONS</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">FILE_OPTIONS</span><span class="p">[</span><span class="n">section</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">section</span><span class="p">:</span>
                <span class="n">conf</span><span class="o">.</span><span class="n">register_opt</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">section</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">conf</span><span class="o">.</span><span class="n">register_opt</span><span class="p">(</span><span class="n">option</span><span class="p">)</span>

    <span class="c"># register any non-default auth methods here (used by extensions, etc)</span>
    <span class="n">setup_authentication</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</pre></div>


<p>所以这一步仅仅是初始化CONF对象，把所有的参数都注册成CONF的属性，方便以后需要的时候调用。但现在也只是注册个默认值，还没有从config_file中读取具体的参数值。</p>
<h6>b. <code>sql.initialize</code>进行数据库相关的初始化设置。</h6>
<p>这部分的具体实现暂时略过。</p>
<h6>c. Log系统的参数注册</h6>
<div class="highlight"><pre><span class="c">#[keystone/config.py]</span>
<span class="k">def</span> <span class="nf">set_default_for_default_log_levels</span><span class="p">():</span>
    <span class="n">extra_log_level_defaults</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">&#39;dogpile=INFO&#39;</span><span class="p">,</span>
        <span class="s">&#39;routes=INFO&#39;</span><span class="p">,</span>
        <span class="s">&#39;keystone.common._memcache_pool=INFO&#39;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">log</span><span class="o">.</span><span class="n">register_options</span><span class="p">(</span><span class="n">CONF</span><span class="p">)</span>
    <span class="n">CONF</span><span class="o">.</span><span class="n">default_log_levels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extra_log_level_defaults</span><span class="p">)</span>
</pre></div>


<p>因为Keysotne使用了部分其他OpenStack服务没有使用的包(如dogpile, routes)，所以这里也对这些包进行了设置。</p>
<h6>d. 读配置文件并初始化CONF</h6>
<div class="highlight"><pre><span class="c">#[keystone/server/common.py]</span>
<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">config_files</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
              <span class="n">pre_setup_logging_fn</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">None</span><span class="p">):</span>
            <span class="o">....</span>
    <span class="n">CONF</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="s">&#39;keystone&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
         <span class="n">default_config_files</span><span class="o">=</span><span class="n">config_files</span><span class="p">)</span>
            <span class="o">....</span>
</pre></div>


<p>这里所做的就是从config_files中读取配置文件，覆盖CONF中的那些默认值。config_files就是keystone.conf文件。</p>
<h6>e. Log系统的初始化</h6>
<div class="highlight"><pre><span class="c">#[keystone/config.py]</span>
<span class="k">def</span> <span class="nf">setup_logging</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Sets up logging for the keystone package.&quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">CONF</span><span class="p">,</span> <span class="s">&#39;keystone&#39;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">captureWarnings</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
</pre></div>


<p>其中用到了python的logging模块以及OpenStack oslo.log。</p>
<h5>3. 获取<code>paste.deploy</code>的路径</h5>
<div class="highlight"><pre>    <span class="n">paste_config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">find_paste_config</span><span class="p">()</span>
</pre></div>


<p>Keystone的<code>paste.deploy</code>的配置文件一般在<code>keystone.conf</code>中的<code>[paste_deploy]</code>部分指出，如：</p>
<div class="highlight"><pre><span class="k">[paste_deploy]</span>
<span class="na">config_file</span> <span class="o">=</span> <span class="s">keystone-paste.ini</span>
</pre></div>


<h5>4. 设置backends</h5>
<div class="highlight"><pre>    <span class="c">#[keystone/server/eventlet.py]</span>
    <span class="n">_unused</span><span class="p">,</span> <span class="n">servers</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">setup_backends</span><span class="p">(</span>
        <span class="n">startup_application_fn</span><span class="o">=</span><span class="n">create_servers</span><span class="p">)</span>
</pre></div>


<p>其主要通过调用<code>setup_backends</code>函数并传入一个子函数<code>create_servers</code>来完成：</p>
<div class="highlight"><pre><span class="c">#[keystone/server/common.py]</span>
<span class="k">def</span> <span class="nf">setup_backends</span><span class="p">(</span><span class="n">load_extra_backends_fn</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{},</span>
                   <span class="n">startup_application_fn</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">None</span><span class="p">):</span>
    <span class="n">drivers</span> <span class="o">=</span> <span class="n">backends</span><span class="o">.</span><span class="n">load_backends</span><span class="p">()</span>
    <span class="n">drivers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">load_extra_backends_fn</span><span class="p">())</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">startup_application_fn</span><span class="p">()</span>
    <span class="n">drivers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dependency</span><span class="o">.</span><span class="n">resolve_future_dependencies</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">drivers</span><span class="p">,</span> <span class="n">res</span>
</pre></div>


<p>首先通过<code>backends.load_backends()</code>加载backends。</p>
<div class="highlight"><pre><span class="c">#[keystone/backends.py ]</span>
<span class="k">def</span> <span class="nf">load_backends</span><span class="p">():</span>

    <span class="c"># Configure and build the cache</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">configure_cache_region</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">REGION</span><span class="p">)</span>

    <span class="c"># Ensure that the identity driver is created before the assignment manager</span>
    <span class="c"># and that the assignment driver is created before the resource manager.</span>
    <span class="c"># The default resource driver depends on assignment, which in turn</span>
    <span class="c"># depends on identity - hence we need to ensure the chain is available.</span>
    <span class="n">_IDENTITY_API</span> <span class="o">=</span> <span class="n">identity</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span>
    <span class="n">_ASSIGNMENT_API</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span>

    <span class="n">DRIVERS</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">assignment_api</span><span class="o">=</span><span class="n">_ASSIGNMENT_API</span><span class="p">,</span>
        <span class="n">catalog_api</span><span class="o">=</span><span class="n">catalog</span><span class="o">.</span><span class="n">Manager</span><span class="p">(),</span>
        <span class="n">credential_api</span><span class="o">=</span><span class="n">credential</span><span class="o">.</span><span class="n">Manager</span><span class="p">(),</span>
        <span class="n">domain_config_api</span><span class="o">=</span><span class="n">resource</span><span class="o">.</span><span class="n">DomainConfigManager</span><span class="p">(),</span>
        <span class="n">endpoint_filter_api</span><span class="o">=</span><span class="n">endpoint_filter</span><span class="o">.</span><span class="n">Manager</span><span class="p">(),</span>
        <span class="n">endpoint_policy_api</span><span class="o">=</span><span class="n">endpoint_policy</span><span class="o">.</span><span class="n">Manager</span><span class="p">(),</span>
        <span class="n">federation_api</span><span class="o">=</span><span class="n">federation</span><span class="o">.</span><span class="n">Manager</span><span class="p">(),</span>
        <span class="n">id_generator_api</span><span class="o">=</span><span class="n">identity</span><span class="o">.</span><span class="n">generator</span><span class="o">.</span><span class="n">Manager</span><span class="p">(),</span>
        <span class="n">id_mapping_api</span><span class="o">=</span><span class="n">identity</span><span class="o">.</span><span class="n">MappingManager</span><span class="p">(),</span>
        <span class="n">identity_api</span><span class="o">=</span><span class="n">_IDENTITY_API</span><span class="p">,</span>
        <span class="n">oauth_api</span><span class="o">=</span><span class="n">oauth1</span><span class="o">.</span><span class="n">Manager</span><span class="p">(),</span>
        <span class="n">policy_api</span><span class="o">=</span><span class="n">policy</span><span class="o">.</span><span class="n">Manager</span><span class="p">(),</span>
        <span class="n">resource_api</span><span class="o">=</span><span class="n">resource</span><span class="o">.</span><span class="n">Manager</span><span class="p">(),</span>
        <span class="n">revoke_api</span><span class="o">=</span><span class="n">revoke</span><span class="o">.</span><span class="n">Manager</span><span class="p">(),</span>
        <span class="n">role_api</span><span class="o">=</span><span class="n">assignment</span><span class="o">.</span><span class="n">RoleManager</span><span class="p">(),</span>
        <span class="n">token_api</span><span class="o">=</span><span class="n">token</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">Manager</span><span class="p">(),</span>

    <span class="n">auth</span><span class="o">.</span><span class="n">controllers</span><span class="o">.</span><span class="n">load_auth_methods</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">DRIVERS</span>
</pre></div>


<p>这里详细看一下<code>load_backends</code>这个方法，首先是建立keystone cache层的配置项(这里的cache就是<code>dogpile.cache</code>，关于cache后面的文章会详细探究，这里只简略带过)。</p>
<p>观察下面的代码可以发现，它们基本上有一个共同的模式：<code>xxx_api=xxxx.Manager()</code>。所以本着窥一斑而知全豹的思想，我们只需要分析下<code>identity_api=_IDENTITY_API</code>，便可以大体知道其他赋值语句是什么作用了。
<code>identity</code>这个module在keystone这个目录下。先来看下其目录结构：</p>
<div class="highlight"><pre><span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">5</span> <span class="n">stack</span> <span class="n">stack</span>  <span class="mi">4096</span> <span class="n">Mar</span>  <span class="mi">9</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span> <span class="p">.</span><span class="o">/</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">20</span> <span class="n">stack</span> <span class="n">stack</span>  <span class="mi">4096</span> <span class="n">Mar</span> <span class="mi">10</span> <span class="mo">02</span><span class="o">:</span><span class="mo">05</span> <span class="p">..</span><span class="o">/</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">2</span> <span class="n">stack</span> <span class="n">stack</span>  <span class="mi">4096</span> <span class="n">Mar</span>  <span class="mi">9</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span> <span class="n">backends</span><span class="o">/</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">stack</span> <span class="n">stack</span> <span class="mi">14225</span> <span class="n">Mar</span>  <span class="mi">9</span> <span class="mo">07</span><span class="o">:</span><span class="mi">18</span> <span class="n">controllers</span><span class="p">.</span><span class="n">py</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">stack</span> <span class="n">stack</span> <span class="mi">11876</span> <span class="n">Mar</span>  <span class="mi">9</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span> <span class="n">controllers</span><span class="p">.</span><span class="n">pyc</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">stack</span> <span class="n">stack</span> <span class="mi">50588</span> <span class="n">Mar</span>  <span class="mi">9</span> <span class="mo">07</span><span class="o">:</span><span class="mi">18</span> <span class="n">core</span><span class="p">.</span><span class="n">py</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">stack</span> <span class="n">stack</span> <span class="mi">42321</span> <span class="n">Mar</span>  <span class="mi">9</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span> <span class="n">core</span><span class="p">.</span><span class="n">pyc</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">stack</span> <span class="n">stack</span>  <span class="mi">1582</span> <span class="n">Mar</span>  <span class="mi">9</span> <span class="mo">07</span><span class="o">:</span><span class="mi">18</span> <span class="n">generator</span><span class="p">.</span><span class="n">py</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">stack</span> <span class="n">stack</span>  <span class="mi">1880</span> <span class="n">Mar</span>  <span class="mi">9</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span> <span class="n">generator</span><span class="p">.</span><span class="n">pyc</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">2</span> <span class="n">stack</span> <span class="n">stack</span>  <span class="mi">4096</span> <span class="n">Mar</span>  <span class="mi">9</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span> <span class="n">id_generators</span><span class="o">/</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">stack</span> <span class="n">stack</span>   <span class="mi">775</span> <span class="n">Mar</span>  <span class="mi">9</span> <span class="mo">07</span><span class="o">:</span><span class="mi">18</span> <span class="n">__init__</span><span class="p">.</span><span class="n">py</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">stack</span> <span class="n">stack</span>   <span class="mi">337</span> <span class="n">Mar</span>  <span class="mi">9</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span> <span class="n">__init__</span><span class="p">.</span><span class="n">pyc</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">2</span> <span class="n">stack</span> <span class="n">stack</span>  <span class="mi">4096</span> <span class="n">Mar</span>  <span class="mi">9</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span> <span class="n">mapping_backends</span><span class="o">/</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">stack</span> <span class="n">stack</span>  <span class="mi">3123</span> <span class="n">Mar</span>  <span class="mi">9</span> <span class="mo">07</span><span class="o">:</span><span class="mi">18</span> <span class="n">routers</span><span class="p">.</span><span class="n">py</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">stack</span> <span class="n">stack</span>  <span class="mi">2554</span> <span class="n">Mar</span>  <span class="mi">9</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span> <span class="n">routers</span><span class="p">.</span><span class="n">pyc</span>
</pre></div>


<p>查看<code>core.py</code>中的<code>Manager</code>类可以发现：</p>
<div class="highlight"><pre><span class="c">#[keystone/identity/core.py]</span>
<span class="nd">@dependency.provider</span><span class="p">(</span><span class="s">&#39;identity_api&#39;</span><span class="p">)</span>
<span class="nd">@dependency.requires</span><span class="p">(</span><span class="s">&#39;assignment_api&#39;</span><span class="p">,</span> <span class="s">&#39;credential_api&#39;</span><span class="p">,</span> <span class="s">&#39;id_mapping_api&#39;</span><span class="p">,</span>
                     <span class="s">&#39;resource_api&#39;</span><span class="p">,</span> <span class="s">&#39;revoke_api&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Manager</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">Manager</span><span class="p">):</span>
</pre></div>


<p>需要提到的是这里用到了一个带有<code>dependency</code>对象的装饰器，那么它有什么作用呢？这个dependency是keystone中用来实现依赖注入的一个模块，作用如下：如果一个类加有<code>@dependency.provider('xxx')</code>修饰时，这个类的成员将会把自己注册成为名为<code>xxx</code>的依赖关系的provider。那这些provider如何被customer使用呢？只需要在对应的类之前加上<code>@dependency.requires('xxx')</code>或者<code>@dependency.optional('xxx')</code>这样的装饰器即可。加上装饰后，这些类的实例会有一个名为<code>xxx</code>的属性，该属性的值便是对<code>xxx</code>的引用。如下例所示：</p>
<div class="highlight"><pre>        <span class="nd">@dependency.provider</span><span class="p">(</span><span class="s">&#39;foo_api&#39;</span><span class="p">)</span>
        <span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="o">...</span>

            <span class="o">...</span>

        <span class="n">foo</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span>

            <span class="o">.........</span>

        <span class="nd">@dependency.requires</span><span class="p">(</span><span class="s">&#39;foo_api&#39;</span><span class="p">,</span> <span class="s">&#39;bar_api&#39;</span><span class="p">)</span>
        <span class="k">class</span> <span class="nc">FooBarClient</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="o">...</span>

            <span class="o">...</span>

        <span class="n">client</span> <span class="o">=</span> <span class="n">FooBarClient</span><span class="p">()</span>
</pre></div>


<p>对象<code>foo</code>会被注册成依赖关系<code>foo_api</code>的provider，而对象<code>client</code>则会拥有<code>foo_api</code>和<code>bar_api</code>这两个属性。</p>
<p>需要提到的是在初始化identity这个Manager的时候，我们的@dependency.requires(‘assignment_api’, ‘credential_api’, ‘token_api’)是不满足要求的，因为这三个API我们还没通过dependency.provider注册。因为这些require的dependency需要等到<code>resolve_future_dependencies</code>被调用后才能被正常使用。</p>
<p>还有<code>@requires</code>和<code>@optional</code>的区别在于：通过前者注册的话，provider必须存在，否则在<code>resolve_future_dependencies()</code>被调用的时候会抛出<code>UnresolvableDependencyException</code>的异常；而通过后者注册的话，如果provider不存在，那么实例中对应的属性被设置成<code>None</code>。</p>
<p>继续对<code>core.py</code>中<code>Manager</code>类的分析,可以发现<code>Manager</code>继承了<code>manager.Manager</code>:</p>
<div class="highlight"><pre><span class="c">#[keystone/common/manager.py]</span>
<span class="k">class</span> <span class="nc">Manager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">importutils</span><span class="o">.</span><span class="n">import_object</span><span class="p">(</span><span class="n">driver_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Forward calls to the underlying driver.&quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span>
</pre></div>


<p>这里的__init__构造函数很简单，就是import一个module，回过头去看继承者identity的__init__：</p>
<div class="highlight"><pre><span class="c">#[keystone/identity/core.py]</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Manager</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">CONF</span><span class="o">.</span><span class="n">identity</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain_configs</span> <span class="o">=</span> <span class="n">DomainConfigs</span><span class="p">()</span>
</pre></div>


<p><code>CONF.identity.driver</code>就是<code>keystone.conf</code>文件里的<code>driver = keystone.identity.backends.sql.Identity</code>。因此__init__初始化操作就是导入了这个sql的driver。然后每次调用manager的某个方法时，如果其没有这个方法（因为大部分具体的方法实现都在driver部分），那么就调用__getattr__从底层的driver取，同时自己也会对这个方法进行注册，省的每次都要重新去取，所以就通过setattr(self, name, _wrapper)自己也留了一个引用。此刻manager就有了driver中的某个方法了。</p>
<p>简单总结一下这个模式：<code>xxx_api=xxxx.Manager()</code>。keystone提供了很多的功能，具体的就是assignment、catalog、credential、endpoint_filter、identity、policy、token、trust、token_provider等。当我们在实现某个功能的时候（比如实现catalog），如果想调用assignment的功能，只要在类前加上@dependency.requires(‘assignment_api’)就行了。catalog使用assignment_api提供的api，至于assignment_api底层是如何实现的则无需关心。Manager相当于一个抽象封装层，只提供功能接口，从而有利于拓展性以及支持多类型的backend，而具体实现则是config文件中指定的那些driver。</p>
<h5>5. 启动server</h5>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">create_server</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">workers</span><span class="p">):</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">keystone_service</span><span class="o">.</span><span class="n">loadapp</span><span class="p">(</span><span class="s">&#39;config:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">conf</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">Server</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span>
                                <span class="n">keepalive</span><span class="o">=</span><span class="n">CONF</span><span class="o">.</span><span class="n">eventlet_server</span><span class="o">.</span><span class="n">tcp_keepalive</span><span class="p">,</span>
                                <span class="n">keepidle</span><span class="o">=</span><span class="n">CONF</span><span class="o">.</span><span class="n">eventlet_server</span><span class="o">.</span><span class="n">tcp_keepidle</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">CONF</span><span class="o">.</span><span class="n">eventlet_server_ssl</span><span class="o">.</span><span class="n">enable</span><span class="p">:</span>
        <span class="n">server</span><span class="o">.</span><span class="n">set_ssl</span><span class="p">(</span><span class="n">CONF</span><span class="o">.</span><span class="n">eventlet_server_ssl</span><span class="o">.</span><span class="n">certfile</span><span class="p">,</span>
                       <span class="n">CONF</span><span class="o">.</span><span class="n">eventlet_server_ssl</span><span class="o">.</span><span class="n">keyfile</span><span class="p">,</span>
                       <span class="n">CONF</span><span class="o">.</span><span class="n">eventlet_server_ssl</span><span class="o">.</span><span class="n">ca_certs</span><span class="p">,</span>
                       <span class="n">CONF</span><span class="o">.</span><span class="n">eventlet_server_ssl</span><span class="o">.</span><span class="n">cert_required</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">name</span><span class="p">,</span> <span class="n">ServerWrapper</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">workers</span><span class="p">)</span>
</pre></div>


<p>其中<code>create_server</code>函数完成deploy模块配置信息的读取，通过loadapp加载WSGI服务器配置选项，再通过environment启动带着这些配置选项的Server，并设置ssl协议和证书，保证服务器的安全传输。</p>
<h5>6. 解决依赖</h5>
<div class="highlight"><pre><span class="n">drivers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dependency</span><span class="o">.</span><span class="n">resolve_future_dependencies</span><span class="p">())</span>
</pre></div>


<p>之前提到虽然通过dependency.require了一个API，但这个时候这个API还不存在。这里通过调用这个方法就是用来解决这个问题的。</p>
<h5>7. 开始监听</h5>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">serve</span><span class="p">(</span><span class="o">*</span><span class="n">servers</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">max</span><span class="p">([</span><span class="n">server</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">workers</span> <span class="k">for</span> <span class="n">server</span> <span class="ow">in</span> <span class="n">servers</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">launcher</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">ProcessLauncher</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">launcher</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">ServiceLauncher</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">server</span> <span class="ow">in</span> <span class="n">servers</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">server</span><span class="o">.</span><span class="n">launch_with</span><span class="p">(</span><span class="n">launcher</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Failed to start the </span><span class="si">%(name)s</span><span class="s"> server&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">{</span>
                <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">})</span>
            <span class="k">raise</span>

    <span class="c"># notify calling process we are ready to serve</span>
    <span class="n">systemd</span><span class="o">.</span><span class="n">notify_once</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">server</span> <span class="ow">in</span> <span class="n">servers</span><span class="p">:</span>
        <span class="n">launcher</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</pre></div>


<p>serve函数启动信号监听机制，并start服务器，导入notifier模块，给keystone提供notify的服务，最后调用wait()，开始提供服务。</p>
            </div><!-- /.entry-content -->
			
			
			<ul style="float:right;">
				<li>
					◄&nbsp;&nbsp;<a href="http://www.sanjeo.com/pages/2015/03/01/manila-overview/">
						OpenStack Manila解析 - Manila概述
					</a>
				</li>
				<li>
					►&nbsp;&nbsp;<a href="http://www.sanjeo.com/pages/2015/03/02/openstack-paste-deploy-interpretation/">
						OpenStack基础知识 - Paste Deploy
					</a>
				</li>
			</ul>
			
			
            <div class="comments">
              <h3>Comments</h3>
              <div id="disqus_thread"></div>
              <script type="text/javascript">
                var disqus_identifier = "pages/2015/03/01/keystone-launch-service/";
                (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://sanjeo.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
              </script>
            </div>


        </div><!-- /.eleven.columns -->
        
<div class="three columns">

<div class="sidebarbg">
	<h4>Pages</h4>
	<ul>
		  <li><a href="/functions/categories.html">Categories</a></li>
		  <li><a href="/functions/tags.html">Tags</a></li>
		  <li><a href="/functions/archives.html">Archives</a></li>
	</ul>
</div>

<div class="sidebarbg">
<h4>Categories</h4>
	<ul>
			<li><a href="http://www.sanjeo.com/category/linux.html">Linux</a></li>
			<li><a href="http://www.sanjeo.com/category/openstack.html">OpenStack</a></li>
	</ul>
</div>

<div class="sidebarbg">
	<h4>Tags</h4>
		<ul>
			<li class="tag-4"><a href="http://www.sanjeo.com/tag/manila.html">manila</a></li>
			<li class="tag-1"><a href="http://www.sanjeo.com/tag/keystone.html">keystone</a></li>
			<li class="tag-4"><a href="http://www.sanjeo.com/tag/nova.html">nova</a></li>
			<li class="tag-4"><a href="http://www.sanjeo.com/tag/shell.html">shell</a></li>
			<li class="tag-4"><a href="http://www.sanjeo.com/tag/pastedeploy.html">paste.deploy</a></li>
			<li class="tag-2"><a href="http://www.sanjeo.com/tag/cinder.html">cinder</a></li>
			<li class="tag-4"><a href="http://www.sanjeo.com/tag/glance.html">glance</a></li>
			<li class="tag-2"><a href="http://www.sanjeo.com/tag/ceph.html">ceph</a></li>
			<li class="tag-4"><a href="http://www.sanjeo.com/tag/neutron.html">neutron</a></li>
		</ul>
</div>


<div class="social sidebarbg">
	<nav class="widget">
	  <h4>Social</h4>
	  <ul>
		<li><a target="_blank" href="https://github.com/sanjeo">GitHub</a></li>
		<li><a target="_blank" href="http://weibo.com/u/2079737417">Weibo</a></li>
	  </ul>
	</nav>
</div>

<nav class="widget sidebarbg">
  <h4>Links</h4>
  <ul>
	<li><a target="_blank" href="http://getpelican.com/">Pelican</a></li>
	<li><a target="_blank" href="http://python.org/">Python.org</a></li>
	<li><a target="_blank" href="http://jinja.pocoo.org/">Jinja2</a></li>
  </ul>
</nav>

</div> </div><!-- /.row -->


</section>

       </div><!-- /.row -->
    </div><!-- /.container -->


       <div class="container.nopad bg">

    
        <footer id="credits" class="row">
          <div class="seven columns left-center">

                   <address id="about" class="vcard body">
                    Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                    which takes great advantage of <a href="http://python.org">Python</a>.
                    <br />
                    Based on the <a target="_blank" href="http://gumbyframework.com">Gumby Framework</a>
                    </address>
          </div>


          <div class="seven columns">
            <div class="row">
              <ul class="socbtns">





              </ul>
            </div>
          </div>
        </footer>

    </div>


<script type="text/javascript">
    var disqus_shortname = 'sanjeo';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
  <script src="http://www.sanjeo.com/theme/js/libs/jquery-1.9.1.min.js"></script>
  <script src="http://www.sanjeo.com/theme/js/libs/gumby.min.js"></script>
  <script src="http://www.sanjeo.com/theme/js/plugins.js"></script>
	<script>
	(function() {
		var $backToTopTxt = "返回顶部", $backToTopEle = $('<div class="backToTop"></div>').appendTo($("body"))
			.text($backToTopTxt).attr("title", $backToTopTxt).click(function() {
				$("html, body").animate({ scrollTop: 0 }, 120);
		}), $backToTopFun = function() {
			var st = $(document).scrollTop(), winh = $(window).height();
			(st > 0)? $backToTopEle.show(): $backToTopEle.hide();
			//IE6下的定位
			if (!window.XMLHttpRequest) {
				$backToTopEle.css("top", st + winh - 166);
			}
		};
		$(window).bind("scroll", $backToTopFun);
		$(function() { $backToTopFun(); });
	})();
	</script>
</body>
</html>